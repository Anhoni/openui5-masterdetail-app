/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.getCore().loadLibrary("sap.ui.unified");sap.ui.define(["sap/ui/core/Control","sap/ui/core/format/DateFormat","sap/ui/unified/calendar/CalendarDate","sap/ui/unified/calendar/CalendarUtils","sap/ui/core/LocaleData","sap/ui/core/Locale","sap/ui/core/delegate/ItemNavigation","sap/ui/core/dnd/DragDropInfo","sap/ui/core/CustomData","sap/ui/events/KeyCodes","sap/base/Log","sap/ui/core/Core","./Link","./PlanningCalendarLegend","./SinglePlanningCalendarMonthGridRenderer"],function(t,e,a,n,i,r,o,s,p,l,g,u,d,h,c){"use strict";var f=1.5625;var m=1.5;var D=2.125;var _=1.75;var v=t.extend("sap.m.SinglePlanningCalendarMonthGrid",{metadata:{library:"sap.m",properties:{startDate:{type:"object",group:"Data"},enableAppointmentsDragAndDrop:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{appointments:{type:"sap.ui.unified.CalendarAppointment",multiple:true,singularName:"appointment",dnd:{draggable:true}},specialDates:{type:"sap.ui.unified.DateTypeRange",multiple:true,singularName:"specialDate"},_appsPlaceholders:{type:"sap.m.SinglePlanningCalendarMonthGrid._internal.IntervalPlaceholder",multiple:true,visibility:"hidden",dnd:{droppable:true}}},dnd:true,associations:{legend:{type:"sap.m.PlanningCalendarLegend",multiple:false}},events:{cellPress:{parameters:{startDate:{type:"object"},endDate:{type:"object"}}},moreLinkPress:{parameters:{date:{type:"object"}}},appointmentDrop:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},startDate:{type:"object"},endDate:{type:"object"},copy:{type:"boolean"}}},appointmentSelect:{parameters:{appointment:{type:"sap.ui.unified.CalendarAppointment"},appointments:{type:"sap.ui.unified.CalendarAppointment[]"}}}}}});v.prototype.init=function(){this._aLinks=[];this._handleMorePress=this._handleMorePress.bind(this);this._oDateFormat=e.getDateTimeInstance({pattern:"YYYYMMdd"});this._oFormatAriaApp=e.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY 'at' "+this._getCoreLocaleData().getTimePattern("medium")});this._oFormatAriaFullDayCell=e.getDateTimeInstance({pattern:"EEEE dd/MM/YYYY"});this.setStartDate(new Date);this._configureAppointmentsDragAndDrop()};v.prototype.exit=function(){if(this._oItemNavigation){this.removeDelegate(this._oItemNavigation);this._oItemNavigation.destroy();delete this._oItemNavigation}for(var t=0;t<this._aLinks.length;t++){if(this._aLinks[t]){this._aLinks[t].destroy()}}delete this._aLinks};v.prototype.onBeforeRendering=function(){var t=this.getStartDate();this._oAppointmentsToRender=this._calculateAppointmentsNodes(t);this._createAppointmentsDndPlaceholders(t)};v.prototype.onAfterRendering=function(){this._initItemNavigation()};v.prototype._getColumns=function(){return 7};v.prototype._getRows=function(){return 6};v.prototype._getDateFormatter=function(){return this._oDateFormat};v.prototype._getAppointmetsForADay=function(t){return this._oAppointmentsToRender.filter(function(e){return e.start.valueOf()===t.valueOf()})};v.prototype._getPreviousAppointmetsForADay=function(t){return this._oAppointmentsToRender.filter(function(e){return e.start.valueOf()<t.valueOf()&&e.end.valueOf()>=t.valueOf()}).map(function(e){var a={data:e.data,start:e.start,end:e.end,len:e.len,level:e.level,width:e.width};a.width-=n._daysBetween(t,e.start);a.hasPrevious=true;return a},this)};v.prototype.ontap=function(t){this._fireSelectionEvent(t)};v.prototype.onkeydown=function(t){if(t.which===l.SPACE||t.which===l.ENTER){this._fireSelectionEvent(t);t.preventDefault()}};v.prototype._fireSelectionEvent=function(t){var e=t.srcControl,a=t.target,n=a&&a.classList.contains("sapMSPCMonthDay"),i=a&&a.classList.contains("sapMLnk"),r,o,s;if(e&&e.isA("sap.m.SinglePlanningCalendarMonthGrid")&&n&&!i){r=parseInt(a.getAttribute("sap-ui-date"));o=new Date(r);o=new Date(o.getFullYear(),o.getMonth(),o.getDate());s=new Date(o);s.setDate(s.getDate()+1);this.fireEvent("cellPress",{startDate:o,endDate:s});this.fireAppointmentSelect({appointment:undefined,appointments:this._toggleAppointmentSelection(undefined,true)})}else if(e&&e.isA("sap.ui.unified.CalendarAppointment")){this.fireAppointmentSelect({appointment:e,appointments:this._toggleAppointmentSelection(e,!(t.ctrlKey||t.metaKey))})}};v.prototype._toggleAppointmentSelection=function(t,e){var a=[],n,i,r;if(e){n=this.getAppointments();for(r=0,i=n.length;r<i;r++){if((!t||n[r].getId()!==t.getId())&&n[r].getSelected()){n[r].setProperty("selected",false);a.push(n[r])}}}if(t){t.setProperty("selected",!t.getSelected());a.push(t)}return a};v.prototype._getMoreLink=function(t,e,a){var n=u.getLibraryResourceBundle("sap.m").getText("SPC_MORE_LINK",[t.toString()]),i=new d({text:n,press:this._handleMorePress}).addCustomData(new p({key:"date",value:e.valueOf().toString(),writeToDom:true}));if(this._aLinks[a]){this._aLinks[a].destroy()}this._aLinks[a]=i;return i};v.prototype._handleMorePress=function(t){var e=parseInt(t.getSource().getCustomData()[0].getValue()),a=new Date(e);a=new Date(a.getFullYear(),a.getMonth(),a.getDate());this.fireEvent("moreLinkPress",{date:a})};v.prototype._getCoreLocaleData=function(){var t=u.getConfiguration().getFormatSettings().getFormatLocale().toString(),e=new r(t);return i.getInstance(e)};v.prototype._getCells=function(){return this._getVisibleDays(this.getStartDate())};v.prototype._getVerticalLabels=function(){var t=this._getVisibleDays(this.getStartDate()),e=this._getColumns(),a=[],i=u.getConfiguration().getFormatLocale().toString(),r=this._getCoreLocaleData();for(var o=0;o<this._getRows();o++){a.push(n.calculateWeekNumber(t[o*e].toUTCJSDate(),t[o*e].getYear(),i,r))}return a};v.prototype._getVisibleDays=function(t){var e,n,i,r,o,s,p=[];if(!t){return p}e=a.fromLocalJSDate(t);s=this._getCoreLocaleData().getFirstDayOfWeek();o=new a(e);o.setDate(1);r=o.getDay()-s;if(r<0){r=7+r}if(r>0){o.setDate(1-r)}n=new a(o);for(var l=0;l<this._getColumns()*this._getRows();l++){i=new a(n);p.push(i);n.setDate(n.getDate()+1)}return p};v.prototype._getAppointmentsToRender=function(){return this._oAppointmentsToRender};v.prototype._calculateAppointmentsNodes=function(t){var e=this._getVisibleDays(t),i=e[0],r=e[e.length-1],o=this.getAppointments().filter(function(t){var e=t.getStartDate()&&t.getEndDate();if(!e){g.warning("Appointment "+t.getId()+" has no start or no end date. It is ignored.")}return e}).map(function(t){var e=a.fromLocalJSDate(t.getStartDate()),i=a.fromLocalJSDate(t.getEndDate());return{data:t,start:e,end:i,len:n._daysBetween(i,e)}}).filter(function(t){return n._isBetween(t.start,i,r,true)||n._isBetween(t.end,i,r,true)}).sort(function t(e,a){return e.start.valueOf()-a.start.valueOf()}),s=[],p,l,u,d,h,c,f;for(h=0;h<e.length;h++){s.push([])}for(h=0;h<o.length;h++){p=o[h];l=n._daysBetween(p.start,e[0]);u=l+p.len;l=l>0?l:0;u=u<e.length?u:e.length-1;p.width=p.len+1;d=s[l].indexOf(true);if(d===-1){d=s[l].length}p.level=d;for(c=l;c<=u;c++){s[c][d]=false;for(f=0;f<d;f++){if(s[c][f]===undefined){s[c][f]=true}}}}this._aAppsLevelsPerDay=s;return o};v.prototype._getMoreCountPerCell=function(t){var e=this._aAppsLevelsPerDay[t];var a=this._getMaxAppointments();var n=0;var i=0;if(e.length<=a){return 0}for(var r=0;r<e.length;r++){if(!e[r]){n++}if(r<a-1){i++}}return n-i};v.prototype._configureAppointmentsDragAndDrop=function(){this.addDragDropConfig(new s({sourceAggregation:"appointments",targetAggregation:"_appsPlaceholders",dragStart:function(t){if(!this.getEnableAppointmentsDragAndDrop()){t.preventDefault();return false}var e=function(){var t=jQuery(".sapMSinglePCOverlay");setTimeout(function(){t.addClass("sapMSinglePCOverlayDragging")});jQuery(document).one("dragend",function(){t.removeClass("sapMSinglePCOverlayDragging")})};e()}.bind(this),dragEnter:function(t){var e=t.getParameter("dragSession"),a=function(){var t=jQuery(e.getIndicator());t.css("min-height",e.getDropControl().$().outerHeight());t.css("min-width",e.getDropControl().$().outerWidth())};if(!e.getIndicator()){setTimeout(a,0)}else{a()}},drop:function(t){var e=t.getParameter("dragSession"),i=e.getDragControl(),r=e.getDropControl(),o=r.getDate(),s=a.fromLocalJSDate(i.getStartDate()),p=a.fromLocalJSDate(i.getEndDate()),l=n._daysBetween(o,s),g=new a(s),u=new a(p),d=t.getParameter("browserEvent"),h=d.metaKey||d.ctrlKey;g.setDate(g.getDate()+l);u.setDate(u.getDate()+l);this.$().find(".sapMSinglePCOverlay").removeClass("sapMSinglePCOverlayDragging");if(s.valueOf()===o.valueOf()){return}this.fireAppointmentDrop({appointment:i,startDate:g.toLocalJSDate(),endDate:u.toLocalJSDate(),copy:h})}.bind(this)}))};v.prototype._initItemNavigation=function(){var t=this.getDomRef();this._aGridCells=this.$().find(".sapMSPCMonthDay").toArray();if(!this._oItemNavigation){this._oItemNavigation=new o;this.addDelegate(this._oItemNavigation);this._oItemNavigation.attachEvent(o.Events.BorderReached,this._itemNavigationBorderReached,this)}this._oItemNavigation.setRootDomRef(t);this._oItemNavigation.setItemDomRefs(this._aGridCells);this._oItemNavigation.setCycling(false);this._oItemNavigation.setDisabledModifiers({sapnext:["alt","meta"],sapprevious:["alt","meta"],saphome:["alt","meta"],sapend:["meta"]});this._oItemNavigation.setTableMode(false).setColumns(this._getColumns(),true);this._oItemNavigation.setPageSize(this._aGridCells.length)};v.prototype._itemNavigationBorderReached=function(t){var e,a,n=t.getParameter("event"),i;if(n.target.classList.contains("sapMSPCMonthDay")){e=n.target;a=parseInt(e.getAttribute("sap-ui-date"));switch(n.keyCode){case l.ARROW_LEFT:i=-1;break;case l.ARROW_UP:i=-this._getColumns();break;case l.ARROW_RIGHT:i=1;break;case l.ARROW_DOWN:i=this._getColumns();break;default:break}this.fireEvent("borderReached",{startDate:a,offset:i})}};v.prototype._createAppointmentsDndPlaceholders=function(t){var e=this._getVisibleDays(t);this.destroyAggregation("_appsPlaceholders");for(var a=0;a<e.length;a++){var n=new y({date:e[a]});this.addAggregation("_appsPlaceholders",n,true)}};var y=t.extend("sap.m.SinglePlanningCalendarMonthGrid._internal.IntervalPlaceholder",{metadata:{properties:{date:{type:"object",group:"Data"}}},renderer:function(t,e){t.write("<div");t.writeControlData(e);t.addClass("sapMSinglePCPlaceholder");t.writeClasses();t.write("></div>")}});v.prototype._getCellStartInfo=function(t){var e=u.getLibraryResourceBundle("sap.ui.unified").getText("CALENDAR_START_TIME");return e+": "+this._oFormatAriaFullDayCell.format(t)+"; "};v.prototype._getAppointmentAnnouncementInfo=function(t){var e=u.getLibraryResourceBundle("sap.ui.unified"),a=e.getText("CALENDAR_START_TIME"),n=e.getText("CALENDAR_END_TIME"),i=this._oFormatAriaApp.format(t.getStartDate()),r=this._oFormatAriaApp.format(t.getEndDate()),o=a+": "+i+"; "+n+": "+r;return o+"; "+h.findLegendItemForItem(u.byId(this._sLegendId),t)};v.prototype._getMaxAppointments=function(){return this._isCompact()?4:3};v.prototype._getDensitySizes=function(){return this._isCompact()?{appHeight:f,cellHeaderHeight:m}:{appHeight:D,cellHeaderHeight:_}};v.prototype._isCompact=function(){var t=this.getDomRef()||(this.getParent()&&this.getParent().getDomRef&&this.getParent().getDomRef()||this.getParent()&&this.getParent().getRootNode&&this.getParent().getRootNode());while(t&&t.classList){if(t.classList.contains("sapUiSizeCompact")){return true}t=t.parentNode}return false};return v});